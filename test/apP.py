from data_processing.data_processing import *
from cover.imports import *
from check_com.checkCom_global import *
from send_UART import *
import RPi.GPIO as GPIO


# ƒê·∫∑t kho·∫£ng gi√° tr·ªã ƒë·ªôt bi·∫øn
def get_setting_data():
    send_packet(6, 0,0x44)
    send_packet(6, 1,0x44)


# Bi·∫øn to√†n c·ª•c ƒë·ªÉ theo d√µi tr·∫°ng th√°i
SENSOR1_STATUS = "Online"
SENSOR2_STATUS = "Online"
last_update_times = [None] * 6

def update_sensor_time(sensor_id):
    """C·∫≠p nh·∫≠t th·ªùi gian nh·∫≠n t√≠n hi·ªáu cu·ªëi c√πng c·ªßa c·∫£m bi·∫øn"""
    global last_update_times
    last_update_times[sensor_id] = time.time()

def check_led_status():
    global LOW_BATTERY_LED
    
    # Ki·ªÉm tra pin
    battery_ok = pin_CB_1.get() >= 15 and pin_CB_2.get() >= 15
    battery_low = pin_CB_1.get() < 15 or pin_CB_2.get() < 15
    
    # Ki·ªÉm tra tr·∫°ng th√°i offline
    sensors_offline = (status1.get() == "Offline" or status2.get() == "Offline")
    
    # Ki·ªÉm tra tr·∫°ng th√°i b√¨nh th∆∞·ªùng
    sensors_normal = (status1.get() == "B√¨nh Thuong" and status2.get() == "B√¨nh Thuong")
    
    # B·∫≠t ƒë√®n khi:
    # 1. M·ªôt trong hai c·∫£m bi·∫øn offline
    # 2. C·∫£ 1 trong 2 pin ƒë·ªÅu y·∫øu (<15)
    if sensors_offline or battery_low:
        turn_on_led()
        LOW_BATTERY_LED = True
        print("B·∫≠t ƒë√®n do:")
        if sensors_offline:
            print(f"C√≥ c·∫£m bi·∫øn offline - CB1={status1.get()}, CB2={status2.get()}")
        if battery_low:
            print(f"Pin y·∫øu - CB1={pin_CB_1.get()}, CB2={pin_CB_2.get()}")
        return False
        
    # T·∫Øt ƒë√®n khi t·∫•t c·∫£ ƒëi·ªÅu ki·ªán b√¨nh th∆∞·ªùng
    if battery_ok and sensors_normal:
        turn_off_led()
        LOW_BATTERY_LED = False
        print("T·∫•t c·∫£ tr·∫°ng th√°i b√¨nh th∆∞·ªùng - T·∫Øt ƒë√®n")
        print(f"Tr·∫°ng th√°i c·∫£m bi·∫øn: CB1={status1.get()}, CB2={status2.get()}")
        print(f"Pin c·∫£m bi·∫øn: CB1={pin_CB_1.get()}, CB2={pin_CB_2.get()}")
        return True
        
    # Gi·ªØ nguy√™n tr·∫°ng th√°i ƒë√®n trong c√°c tr∆∞·ªùng h·ª£p kh√°c
    return False

time_offline =(time_loop/1000 * 2 + 5)
def check_sensor_status():
    global SENSOR1_STATUS, SENSOR2_STATUS
    while True:
        current_time = time.time()
        status_changed = False
        
        for i, last_time in enumerate(last_update_times):
            if last_time is None or current_time - last_time > time_offline:
                if i == 0:
                    SENSOR1_STATUS = "Offline"
                    # Lu√¥n set offline khi m·∫•t k·∫øt n·ªëi, k·ªÉ c·∫£ ƒëang ·ªü tr·∫°ng th√°i n∆∞·ªõc ƒë·ª•c
                    status1.set("Offline")
                    status_changed = True
                elif i == 1:
                    SENSOR2_STATUS = "Offline"
                    # Lu√¥n set offline khi m·∫•t k·∫øt n·ªëi, k·ªÉ c·∫£ ƒëang ·ªü tr·∫°ng th√°i n∆∞·ªõc ƒë·ª•c  
                    status2.set("Offline")
                    status_changed = True
            else:
                if i == 0 and status1.get() == "Offline":
                    SENSOR1_STATUS = "Online"
                    status1.set("B√¨nh Thuong")
                    status_changed = True
                elif i == 1 and status2.get() == "Offline":
                    SENSOR2_STATUS = "Online" 
                    status2.set("B√¨nh Thuong")
                    status_changed = True
                    
        # Ch·ªâ ki·ªÉm tra LED khi c√≥ thay ƒë·ªïi tr·∫°ng th√°i
        if status_changed:
            check_led_status()
            
        time.sleep(1)

# H√†m quan tr·ªçng nh·∫≠n d·ªØ li·ªáu r√¥i x·ª≠ l√Ω
def get_data_com(value, arr_avg, sensor, pin_cb):
    # Check d·ªØ li·ªáu t·ª´ c·∫£m bi·∫øn
    print("‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è", sensor)
 
    fromID, toID, title, data_receive = sensor
    
    # # Th√™m ki·ªÉm tra data_receive
    # if not data_receive or len(data_receive) < 2:
    #     print("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu h·ª£p l·ªá t·ª´ c·∫£m bi·∫øn")
    #     return
        
    data = data_receive[0]
    pin = data_receive[1]
    id = fromID
    status = title
    
    if (data):
        update_sensor_time(id)
        if (status == 0x57):
            if (id ==  0):
                print("da luu vao excel  ‚ù§Ô∏è   voi id 0")
                save_data_excel_ngay(None, None, data, None)

            elif (id == 1):
                print("da luu vao excel  ‚ù§Ô∏è   voi id 1")
                save_data_excel_ngay(None, None, None, data)

    #______________________________ Th√¥ng B√°o s√°ng ƒë√®n khi g·∫ßn h·∫øt pin___________________
        elif (status == 0x54):
           
            if (id == 0):
                value.set(data)
                arr_avg.append(data)
                pin_CB_1.set(pin)
                if (pin_CB_1.get()) < 15:
                    turn_on_led()
                    print("üí•Th√¥ng b√°o g·∫ßn h·∫øt pin CB1 üí•")
                else:
                    check_led_status()

            elif (id == 1):
                value.set(data)
                arr_avg.append(data)
                pin_CB_2.set(pin)
                if pin_CB_2.get() < 15:
                    turn_on_led()
                    print("üí•Th√¥ng b√°o g·∫ßn h·∫øt pin CB2 üí•")
                else:
                    check_led_status()

        elif (status == 192):
            if (id == 0):
                threshold_value_1.set(data)
            elif (id == 1):
                threshold_value_2.set(data)

        elif (status == 0x44):
            if (id == 0):
                print("Da nhan duoc gia tri nguong dot bien CB1 üòÅüòÅ")
                sio.emit('threshold-device', {
                    "device": int(id),
                    "threshold": data,
                    "type": "S"
                })
            elif (id == 1):
                print("Da nhan duoc gia tri nguong dot bien CB2 üòÅüòÅ")
                sio.emit('threshold-device', {
                    "device": int(id),
                    "threshold": data,
                    "type": "S"
                })
        elif (status == 201):
            if (id == 0):
                sio.emit('time-clean', {
                    "device": int(id),
                    "timeClean": data,
                    "type": "S"
                })
            elif (id == 1):
                sio.emit('time-clean', {
                    "device": int(id),
                    "timeClean": data,
                    "type": "S"
                })
        elif (data == 204):
            print("ƒê√£ v√†o ƒë√¢y üòòüòòüòòüòòüòòüòòüòòüòòüòòüòò")
            sio.emit('device-status-running', {
                "device": int(id),
                "status": 1,
                "type": "S"
            })

# Thi·∫øt l·∫≠p GPIO
BUTTON_PIN = 16  # The number of the pushbutton pin
LED_PIN = 18     # The number of the LED pin

pressed_once = False
BUTTON_PRESSED = False

GPIO.setmode(GPIO.BCM)
GPIO.setup(LED_PIN, GPIO.OUT)          
GPIO.setup(BUTTON_PIN, GPIO.IN, pull_up_down=GPIO.PUD_UP)

GPIO.output(LED_PIN, GPIO.LOW)  # Kh·ªüi t·∫°o LED ·ªü tr·∫°ng th√°i t·∫Øt

# Xong
def press_button():
    global pressed_once, LOW_BATTERY_LED, BUTTON_PRESSED
    try:    
        while True:
            button_state = GPIO.input(BUTTON_PIN)
            
            # Khi n√∫t ƒë∆∞·ª£c nh·∫•n v√† tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥ l√† False (ch∆∞a nh·∫•n)
            if button_state != pressed_once and button_state == True:
                BUTTON_PRESSED = True
                turn_off_ring()
                ring_status.set("ƒêang Tat")
                print("Chuyen doi trang thai sang bat")
                
            # Khi n√∫t ƒë∆∞·ª£c th·∫£ ra    
            elif button_state != pressed_once and button_state == False:
                BUTTON_PRESSED = False
                print("Chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i ƒêang t·∫Øt")
                
                
            time.sleep(0.1)
            pressed_once = button_state

    except KeyboardInterrupt:
        print("k·∫øt th√∫c")
    finally:
        GPIO.cleanup()

# Th√™m c√°c bi·∫øn to√†n c·ª•c m·ªõi
RING_ACTIVE = False

# H√†m b·∫≠t chu√¥ng ||| xong
def turn_on_ring():
    global RING_ACTIVE, BUTTON_PRESSED
    
    # Ki·ªÉm tra n√∫t nh·∫•n tr∆∞·ªõc khi b·∫≠t chu√¥ng
    if BUTTON_PRESSED == True:
        print("Kh√¥ng g·ª≠i l·ªánh b·∫≠t chu√¥ng v√¨ n√∫t ƒëang ƒë∆∞·ª£c nh·∫•n")
        return
        
    # Ch·ªâ b·∫≠t chu√¥ng n·∫øu ch∆∞a ƒë∆∞·ª£c b·∫≠t
    if not RING_ACTIVE:
        RING_ACTIVE = True
        send_packet(6, 7, 0x6F)
        ring_status.set("ƒêang Bat")
        print("G·ª≠i l·ªánh b·∫≠t chu√¥ng üîî")
    else:
        print("Kh√¥ng g·ª≠i l·ªánh b·∫≠t chu√¥ng v√¨ tr·∫°ng th√°i chu√¥ng ƒëang b·∫≠t")

LOW_BATTERY_LED = False
def turn_off_led():
    global LOW_BATTERY_LED
    LOW_BATTERY_LED = False
    GPIO.output(LED_PIN, GPIO.LOW)
    print("T·∫Øt ƒë√®n - LOW_BATTERY_LED:", LOW_BATTERY_LED)

def turn_on_led():
    global LOW_BATTERY_LED
    LOW_BATTERY_LED = True
    GPIO.output(LED_PIN, GPIO.HIGH)



# H√†m t·∫Øt chu√¥ng||| Xong
def turn_off_ring():
    global RING_ACTIVE
    if RING_ACTIVE:
        send_packet(6, 7, 0x66)
        ring_status.set("ƒêang Tat")
        print("T·∫Øt Chu√¥ng b√°o ‚ùåüîî")
        
        # Reset tr·∫°ng th√°i chu√¥ng v·ªÅ ban ƒë·∫ßu
        RING_ACTIVE = False


# Xong ||| G·ª≠i d·ªØ li·ªáu cho c·∫£ hai c·∫£m bi·∫øn v√† ƒë·ªçc ph·∫£n h·ªìi li√™n t·ª•c
def connect_COM():
    for sensor_id in (0, 1):
        send_packet(6, sensor_id, 0x54)
        time.sleep(2)


# H√†m ki·ªÉm tra cng || Xong
def check_com():
    send_packet(6, 0, 0x54)
    print("ƒëang ch·ªù nh·∫≠n t√≠n hi·ªáu ƒë·ªÉ m·ªü app")
    receive_packet_all()
    

value_compare_list_1 = []


def handle_check_mutate(value1, value2, avg1, avg2, threshold_value_1, threshold_value_2, status1, status2, ring_status, pin_cb1, pin_cb2):
    check_1 = False
    check_2 = False
    value_compare_1 = 0
    value_compare_2 = 0
    global value_compare_list_1 
    global value_compare_list_2

    # X·ª≠ l√Ω c·∫£m bi·∫øn 1 ƒë·ªôc l·∫≠p
    if SENSOR1_STATUS == "Online":
        value_compare_1 = value1.get() - avg1.get()
        if value_compare_1 > threshold_value_1.get():
            print("‚ùåCB1 Da nhan ƒêB lan 1 ")
            value_compare_list_1.append(value_compare_1)
        else:
            status1.set("B√¨nh Thuong")
            sio.emit('water-status', {
                "sensor": "0",
                "status": "C" 
            })
    
        if len(value_compare_list_1) == 2:
            if all(value > threshold_value_1.get() for value in value_compare_list_1):
                check_1 = True
                sio.emit('water-status', {
                    "sensor": "0", 
                    "status": "D"
                })
                mutation_value_1.set(value_compare_1)
                status1.set("Nuoc Duc")
                print("C·∫£m bi·∫øn 1: C·∫£ hai l·∫ßn h·ªèi ƒë·ªÅu v∆∞·ª£t ng∆∞·ª°ng üîîüîî")
                value_compare_list_1.clear()
                
    if SENSOR2_STATUS == "Offline" and check_1:
        print("C·∫£m bi·∫øn 1 ƒë·ªôt bi·∫øn, c·∫£m bi·∫øn 2 offline - B·∫≠t chu√¥ng v√† ƒë√®n") 
        turn_on_ring()
        turn_on_led()


    # X·ª≠ l√Ω c·∫£m bi·∫øn 2 - ch·ªâ c·∫ßn 1 l·∫ßn v∆∞·ª£t ng∆∞·ª°ng
    value_compare_2 = value2.get() - avg2.get()
    if value_compare_2 > threshold_value_2.get():
        check_2 = True
        sio.emit('water-status', {
            "sensor": "1",
            "status": "D"
        })
        mutation_value_2.set(value_compare_2)
        status2.set("Nuoc Duc")
        print("C·∫£m bi·∫øn 2: ƒê√£ v∆∞·ª£t ng∆∞·ª°ng üîî")
        
        if SENSOR1_STATUS == "Offline":
            print("C·∫£m bi·∫øn 2 ƒë·ªôt bi·∫øn, c·∫£m bi·∫øn 1 offline - B·∫≠t chu√¥ng v√† ƒë√®n") 
            turn_on_ring()
            turn_on_led()
    else:
        if SENSOR2_STATUS == "Online":
            status2.set("B√¨nh Thuong")
            sio.emit('water-status', {
                "sensor": "1", 
            "status": "C"
        })

    # B·∫≠t chu√¥ng n·∫øu c·∫£ 2 c·∫£m bi·∫øn c√πng ƒë·ª•c
    if check_1 and check_2:
        print("C·∫£ 2 c·∫£m bi·∫øn ƒë·ªÅu ƒë·ªôt bi·∫øn üí•üí•üí•üí•üí•üí•üí•üí•üí•üí•üí•üí•")
        ring_status.set("ƒêang Bat")
        turn_on_ring()
        turn_on_led()

    print("Gi√° tr·ªã trung b√¨nh c·∫£m bi·∫øn 1:", avg1.get())
    print("Gi√° tr·ªã trung b√¨nh c·∫£m bi·∫øn 2:", avg2.get()) 
    print("Gi√° tr·ªã ƒë·ªôt bi·∫øn 1:", value_compare_1)
    print("Gi√° tr·ªã ƒë·ªôt bi·∫øn 2:", value_compare_2)

""" H√†m Kh·ªüi ƒë·ªông c√πng m√°y t√≠nh"""

# Thay b·∫±ng ƒë∆∞·ªùng d·∫´n Python.
def add_to_startup():
    # T·∫°o th∆∞ m·ª•c autostart n·∫øu ch∆∞a t·ªìn t·∫°i
    autostart_dir = os.path.expanduser("~/.config/autostart")
    if not os.path.exists(autostart_dir):
        os.makedirs(autostart_dir)

    # T·∫°o file .desktop
    desktop_entry = os.path.join(autostart_dir, "catam_gui.desktop")
    with open(desktop_entry, "w") as file:
        file.write(f"""[Desktop Entry]
Type=Application
Name=App_Ca_tam
Exec=python3 {os.path.abspath("main.py")}  
StartupNotify=false
Terminal= True
""")
    print("File startup ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng t·∫°i", desktop_entry)




